# backend/app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.openapi.utils import get_openapi
from datetime import datetime
import logging

from app.config import settings, get_api_prefix
from app.db.database import engine, Base

# Configure logging
logging.basicConfig(
    level=settings.log_level,
    format=settings.log_format
)
logger = logging.getLogger(__name__)

# Create tables (only for dev, use migrations in production)
if settings.is_development:
    Base.metadata.create_all(bind=engine)
    logger.info("Database tables created (development mode)")

# Initialize FastAPI with ALL settings from config
app = FastAPI(
    title=settings.api.title,
    version=settings.api.version,
    description=settings.api.description,
    summary=settings.api.summary,
    terms_of_service=settings.api.terms_of_service,
    contact={
        "name": settings.api.contact_name,
        "url": settings.api.contact_url,
        "email": settings.api.contact_email,
    },
    license_info={
        "name": settings.api.license_name,
        "url": settings.api.license_url,
    },
    docs_url=settings.api.docs_url,
    redoc_url=settings.api.redoc_url,
    openapi_url=settings.api.openapi_url,
    openapi_tags=settings.api.tags_metadata,
    debug=settings.debug,
)

logger.info(
    f"Starting {settings.api.name} {settings.api.version} "
    f"in {settings.environment} mode"
)

# CORS with settings
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors.allowed_origins,
    allow_credentials=settings.cors.allow_credentials,
    allow_methods=settings.cors.allow_methods,
    allow_headers=settings.cors.allow_headers,
)


def custom_openapi():
    """
    Custom OpenAPI schema - fully dynamic from settings
    """
    if app.openapi_schema:
        return app.openapi_schema
    
    # Generate base schema (gi√† include contact, license, etc. da FastAPI init)
    openapi_schema = get_openapi(
        title=settings.api.title,
        version=settings.api.version,
        description=settings.api.description,
        routes=app.routes,
        tags=settings.api.tags_metadata,
        terms_of_service=settings.api.terms_of_service,
        contact={
            "name": settings.api.contact_name,
            "url": settings.api.contact_url,
            "email": settings.api.contact_email,
        },
        license_info={
            "name": settings.api.license_name,
            "url": settings.api.license_url,
        },
    )
    
    # Add custom extensions (logo, etc.)
    if settings.api.logo_url:
        openapi_schema["info"]["x-logo"] = {
            "url": settings.api.logo_url,
            "altText": f"{settings.api.name} Logo"
        }
    
    # Security schemes
    openapi_schema["components"]["securitySchemes"] = {
        "bearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT",
            "description": (
                f"JWT token obtained from {get_api_prefix()}/auth/login endpoint. "
                f"Token expires after {settings.security.access_token_expire_minutes} minutes."
            )
        }
    }
    
    # Apply security globally
    openapi_schema["security"] = [{"bearerAuth": []}]
    
    # Add custom metadata
    openapi_schema["info"]["x-api-id"] = f"{settings.api.name.lower()}-api"
    openapi_schema["info"]["x-audience"] = "external"
    openapi_schema["info"]["x-environment"] = settings.environment
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema


app.openapi = custom_openapi


# ============================================================================
# HEALTH CHECK ENDPOINTS
# ============================================================================

@app.get("/", tags=["Health"], include_in_schema=False)
async def root():
    """
    Root endpoint - API information and status
    """
    return {
        "name": settings.api.name,
        "version": settings.api.version,
        "api_version": settings.api.api_version,
        "environment": settings.environment,
        "status": "running",
        "docs": settings.api.docs_url,
        "redoc": settings.api.redoc_url,
        "openapi": settings.api.openapi_url,
    }


@app.get("/health", tags=["Health"])
async def health_check():
    """
    Health check endpoint for monitoring and load balancers
    
    Returns service health status with version information
    """
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "service": settings.api.name,
        "version": settings.api.version,
        "api_version": settings.api.api_version,
        "environment": settings.environment,
        "features": {
            "ai_classification": settings.features.enable_ai_classification,
            "vector_search": settings.features.enable_vector_search,
            "analytics": settings.features.enable_analytics,
        }
    }


@app.get("/version", tags=["Health"])
async def version_info():
    """
    Detailed version information
    """
    return {
        "app_name": settings.api.name,
        "app_version": settings.api.version,
        "api_version": settings.api.api_version,
        "environment": settings.environment,
        "python_version": "3.11+",
        "debug_mode": settings.debug,
    }


# ============================================================================
# ROUTERS
# ============================================================================

# Import routers
from app.api import auth, accounts, categories

# Get API prefix from settings
API_PREFIX = get_api_prefix()

# Register routers with dynamic prefix
app.include_router(
    auth.router,
    prefix=f"{API_PREFIX}/auth",
    tags=["Authentication"]
)

app.include_router(
    accounts.router,
    prefix=f"{API_PREFIX}/accounts",
    tags=["Accounts"]
)

app.include_router(
    categories.router,
    prefix=f"{API_PREFIX}/categories",
    tags=["Categories"]
)

# Future routers (commented for now)
# app.include_router(
#     transactions.router,
#     prefix=f"{API_PREFIX}/transactions",
#     tags=["Transactions"]
# )
# 
# app.include_router(
#     budgets.router,
#     prefix=f"{API_PREFIX}/budgets",
#     tags=["Budgets"]
# )

logger.info(f"Routers registered with prefix: {API_PREFIX}")
logger.info(f"API documentation available at: {settings.api.docs_url}")